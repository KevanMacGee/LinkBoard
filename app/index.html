<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>LinkBoard â€” Webâ€‘Dev Tools</title>
    <link rel="icon" href="data:," />
    <style>
      :root {
        --bg: #f6f8fb;
        --panel: #ffffff;
        --panel-2: #f9fbff;
        --muted: #6b7280;
        --text: #111827;
        --accent: #2563eb;
        --accent-2: #06b6d4;
        --danger: #e11d48;
        --shadow: 0 8px 22px rgba(0, 0, 0, 0.08);
        --radius: 16px;
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        font: 15px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
        color: var(--text);
        background: radial-gradient(900px 420px at 10% -10%, #eef2ff 0, rgba(238, 242, 255, 0) 55%),
          radial-gradient(900px 420px at 110% -10%, #e0f2fe 0, rgba(224, 242, 254, 0) 55%), var(--bg);
      }
      header {
        position: sticky;
        top: 0;
        z-index: 5;
        background: linear-gradient(
          0deg,
          rgba(246, 248, 251, 0),
          rgba(246, 248, 251, 0.9) 30%,
          rgba(246, 248, 251, 0.98)
        );
        backdrop-filter: blur(8px);
        border-bottom: 1px solid #e5e7eb;
      }
      .bar {
        max-width: 1600px;
        margin: 0 auto;
        padding: 14px 18px;
        display: grid;
        grid-template-columns: 1fr 2fr 1fr;
        gap: 12px;
        align-items: center;
      }
      h1 {
        font-size: 24px;
        margin: 0;
        letter-spacing: 0.2px;
        font-weight: 650;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      h1 .dot {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        background: var(--accent);
        box-shadow: 0 0 12px var(--accent);
        display: inline-block;
      }

      .actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .actions button,
      .actions label.btn {
        appearance: none;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: 8px 12px;
        cursor: pointer;
        color: var(--text);
        background: linear-gradient(180deg, #f3f6fb, #e9eef7);
        box-shadow: var(--shadow);
        font-family: inherit;
        text-decoration: none;
      }
      .actions button:hover,
      .actions label.btn:hover {
        outline: 2px solid rgba(37, 99, 235, 0.18);
      }
      .actions button.danger {
        background: linear-gradient(180deg, #ffe4e6, #fecaca);
        color: #7f1d1d;
        border-color: #fecaca;
      }
      .search {
        width: 100%;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid #e5e7eb;
        background: #ffffff;
        color: var(--text);
      }

      /* Board */
      .wrap {
        max-width: 1600px;
        margin: 22px auto;
        padding: 0 18px 80px;
      }
      .board {
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 16px;
      }
      @media (max-width: 1280px) {
        .board {
          grid-template-columns: repeat(3, minmax(0, 1fr));
        }
      }
      @media (max-width: 900px) {
        .board {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
      }
      @media (max-width: 600px) {
        .board {
          grid-template-columns: 1fr;
        }
      }
      .col {
        background: linear-gradient(180deg, var(--panel), var(--panel-2));
        border: 1px solid #e5e7eb;
        border-radius: var(--radius);
        min-height: 100px;
        box-shadow: var(--shadow);
        display: flex;
        flex-direction: column;
      }
      .col header {
        position: relative;
        inset: unset;
        background: none;
        backdrop-filter: none;
        border-bottom: 1px solid #eef2f7;
      }
      .col h2 {
        font-size: 18px;
        margin: 0;
        padding: 10px 12px;
        letter-spacing: 0.2px;
        color: var(--text);
        font-weight: 650;
        text-align: center;
      }
      .list {
        list-style: none;
        margin: 0;
        padding: 10px;
        display: grid;
        gap: 10px;
        min-height: 80px;
      }

      .card {
        display: grid;
        grid-template-columns: 28px 1fr auto;
        align-items: center;
        gap: 10px;
        padding: 10px;
        border-radius: 12px;
        background: #ffffff;
        border: 1px solid #e5e7eb;
        cursor: grab;
      }
      .card:active {
        cursor: grabbing;
      }
      .card .icon {
        width: 22px;
        height: 22px;
        border-radius: 6px;
        overflow: hidden;
        background: #f1f5f9;
        display: grid;
        place-items: center;
      }
      .card .icon img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .card a.title {
        color: var(--text);
        font-weight: 600;
        text-decoration: none;
      }
      .card .meta {
        color: var(--muted);
        font-size: 12px;
      }
      .card .buttons {
        display: flex;
        gap: 6px;
      }
      .btn-icon {
        border: 1px solid #e5e7eb;
        background: #f8fafc;
        color: #64748b;
        width: 28px;
        height: 28px;
        border-radius: 8px;
        display: grid;
        place-items: center;
        cursor: pointer;
      }
      .btn-icon:hover {
        color: var(--text);
        border-color: #cbd5e1;
      }

      .empty {
        opacity: 0.7;
        text-align: center;
        font-size: 13px;
        padding: 14px 10px 18px;
        color: #6b7280;
        pointer-events: none;
      }

      /* Dialog */
      dialog {
        border: 1px solid #e5e7eb;
        border-radius: 16px;
        padding: 0;
        background: linear-gradient(180deg, var(--panel), var(--panel-2));
        color: var(--text);
        box-shadow: var(--shadow);
        max-width: 560px;
        width: 96vw;
      }
      dialog::backdrop {
        background: rgba(35, 39, 49, 0.35);
        backdrop-filter: blur(2px);
      }
      .dlg-head {
        padding: 14px 16px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .dlg-head h3 {
        margin: 0;
        font-size: 16px;
      }
      .dlg-body {
        padding: 16px;
        display: grid;
        gap: 12px;
      }
      .row {
        display: grid;
        gap: 6px;
      }
      label {
        font-size: 12px;
        color: var(--muted);
      }
      input[type="text"],
      select,
      textarea {
        width: 100%;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid #e5e7eb;
        background: #ffffff;
        color: var(--text);
      }
      textarea {
        min-height: 80px;
        resize: vertical;
      }
      .dlg-foot {
        padding: 14px 16px;
        border-top: 1px solid #e5e7eb;
        display: flex;
        gap: 8px;
        justify-content: flex-end;
      }
      .pill {
        border-radius: 999px;
        padding: 8px 14px;
        background: linear-gradient(180deg, #eff6ff, #e0ecff);
        color: var(--text);
        border: 1px solid #dbeafe;
        cursor: pointer;
      }
      .pill.alt {
        background: #f8fafc;
        border: 1px solid #e5e7eb;
      }
      .pill.danger {
        background: linear-gradient(180deg, #fee2e2, #fecaca);
        color: #7f1d1d;
        border: 1px solid #fecaca;
      }

      .hint {
        color: var(--muted);
        font-size: 12px;
      }
      .kbd {
        background: #f8fafc;
        border: 1px solid #e5e7eb;
        padding: 2px 6px;
        border-radius: 8px;
        font-weight: 600;
      }

      /* Search Row */
      .search-row {
        max-width: 1600px;
        margin: 0 auto;
        padding: 0 18px;
        display: flex;
        justify-content: center;
        margin-top: 12px;
      }
      .search-row .search {
        max-width: 600px;
        width: 100%;
      }

      /* Bottom Actions */
      .bottom-actions {
        max-width: 1600px;
        margin: 0 auto;
        padding: 0 18px;
        display: flex;
        gap: 8px;
        justify-content: flex-end;
        margin-top: 20px;
        margin-bottom: 20px;
      }
      .bottom-actions button,
      .bottom-actions label.btn {
        appearance: none;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: 8px 12px;
        cursor: pointer;
        color: var(--text);
        background: linear-gradient(180deg, #f3f6fb, #e9eef7);
        box-shadow: var(--shadow);
        font-family: inherit;
        text-decoration: none;
      }
      .bottom-actions button:hover,
      .bottom-actions label.btn:hover {
        outline: 2px solid rgba(37, 99, 235, 0.18);
      }
      .bottom-actions button.danger {
        background: linear-gradient(180deg, #ffe4e6, #fecaca);
        color: #7f1d1d;
        border-color: #fecaca;
      }

      /* Column Manager */
      .cols-list {
        display: grid;
        gap: 10px;
      }
      .colmgr-row {
        display: grid;
        grid-template-columns: auto 1fr auto;
        align-items: center;
        gap: 8px;
      }
      .colmgr-row .order {
        width: 80px;
        display: flex;
        gap: 6px;
      }
      .colmgr-row input[type="text"] {
        width: 100%;
        padding: 8px 10px;
        border-radius: 10px;
        border: 1px solid #e5e7eb;
        background: #ffffff;
        color: var(--text);
      }
      .colmgr-actions {
        display: flex;
        gap: 6px;
      }
      .colmgr-hint {
        margin-top: 6px;
      }

      /* â€”â€”â€” Dark theme (Neutral Glass, no blue) â€”â€”â€” */
      [data-theme="dark"] {
        --bg: #222222; /* page background */
        --panel: #1f1f1f; /* main cards/panels */
        --panel-2: #1a1a1a; /* subdued surfaces */
        --text: #e9e9e9;
        --muted: #b8b8b8;
        --accent: #f3f3f3; /* neutral highlight */
        --accent-2: #dcdcdc;
        --danger: #f2b8b5;
        --border: #303030;
        --shadow: 0 12px 28px rgba(0, 0, 0, 0.45);
      }
      [data-theme="dark"] body {
        background: radial-gradient(900px 420px at 10% -10%, rgba(255, 255, 255, 0.07) 0, rgba(255, 255, 255, 0) 55%),
          radial-gradient(900px 420px at 110% -10%, rgba(255, 255, 255, 0.05) 0, rgba(255, 255, 255, 0) 55%), var(--bg);
        color: var(--text);
      }
      [data-theme="dark"] header {
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.045),
          rgba(255, 255, 255, 0.02) 60%,
          rgba(0, 0, 0, 0.05)
        );
        border-bottom: 1px solid var(--border);
      }
      [data-theme="dark"] .col {
        border-color: var(--border);
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.035), rgba(255, 255, 255, 0.02));
        color: var(--text);
        box-shadow: var(--shadow);
      }
      /* Dark theme - dialog with lighter colors to match column appearance */
      [data-theme="dark"] dialog {
        background: linear-gradient(180deg, #2a2a2a, #282828);
        border: 1px solid var(--border);
        box-shadow: var(--shadow);
        color: var(--text);
      }
      [data-theme="dark"] .col header {
        border-bottom: 1px solid var(--border);
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.06), rgba(255, 255, 255, 0.03));
      }
      [data-theme="dark"] .card,
      [data-theme="dark"] input[type="text"],
      [data-theme="dark"] select,
      [data-theme="dark"] textarea {
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.025));
        border: 1px solid var(--border);
        color: var(--text);
        box-shadow: none;
      }
      /* Style select dropdown options in dark mode */
      [data-theme="dark"] select option {
        background: #2a2a2a;
        color: var(--text);
      }
      [data-theme="dark"] select option:hover,
      [data-theme="dark"] select option:checked {
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.05));
      }
      /* Better focus state for select in dark mode */
      [data-theme="dark"] select:focus {
        outline: 2px solid rgba(255, 255, 255, 0.1);
        outline-offset: -1px;
      }
      [data-theme="dark"] .card .icon {
        background: #181818;
      }
      [data-theme="dark"] .btn-icon {
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.04), rgba(255, 255, 255, 0.02));
        border: 1px solid var(--border);
        color: #cfcfcf;
      }
      [data-theme="dark"] .btn-icon:hover {
        color: var(--text);
        border-color: #3a3a3a;
      }
      [data-theme="dark"] .actions button,
      [data-theme="dark"] .actions label.btn,
      [data-theme="dark"] .bottom-actions button,
      [data-theme="dark"] .bottom-actions label.btn,
      [data-theme="dark"] .pill {
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.06), rgba(255, 255, 255, 0.02));
        border: 1px solid var(--border);
        color: var(--text);
        box-shadow: none;
        font-family: inherit;
        text-decoration: none;
      }
      [data-theme="dark"] .pill.danger {
        background: linear-gradient(180deg, rgba(255, 64, 64, 0.18), rgba(64, 0, 0, 0.08));
        color: #ffdada;
        border-color: #5a1d1d;
      }
      [data-theme="dark"] .bottom-actions button.danger {
        background: linear-gradient(180deg, rgba(255, 64, 64, 0.18), rgba(64, 0, 0, 0.08));
        color: #ffdada;
        border-color: #5a1d1d;
      }
      [data-theme="dark"] .search {
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.04), rgba(255, 255, 255, 0.02));
        border: 1px solid var(--border);
        color: var(--text);
      }
      [data-theme="dark"] .hint {
        color: var(--muted);
      }
      [data-theme="dark"] .kbd {
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.04), rgba(255, 255, 255, 0.02));
        border: 1px solid var(--border);
        color: var(--text);
      }
      [data-theme="dark"] .card a.title {
        color: var(--text);
      }
      [data-theme="dark"] .card .meta {
        color: var(--muted);
      }
      /* Modal header/footer dividers in dark mode */
      [data-theme="dark"] .dlg-head,
      [data-theme="dark"] .dlg-foot {
        border-color: var(--border);
      }
    </style>
  </head>
  <body>
    <header>
      <div class="bar">
        <div style="display: flex; align-items: center; gap: 12px">
          <h1>
            <span class="dot"></span> LinkBoard <span class="hint" style="font-weight: 500">â€” draggable links</span>
          </h1>
        </div>
        <div style="display: flex; align-items: center; justify-content: center; gap: 12px">
          <input
            id="q"
            class="search"
            type="text"
            placeholder="Search title, domain, or noteâ€¦  (press / to focus)"
            aria-label="Search"
            style="max-width: 600px"
          />
        </div>
        <div class="actions" style="justify-content: flex-end">
          <button id="btnAdd">+ Add Link (A)</button>
          <button id="btnCols">Columns</button>
          <button id="btnTheme" title="Toggle dark/light">ðŸŒ™ Dark</button>
        </div>
      </div>
    </header>

    <div class="wrap">
      <div id="board" class="board" role="list" aria-label="Link columns"></div>
    </div>

    <div class="bottom-actions">
      <button id="btnExport">Export</button>
      <label class="btn" for="importFile">Import</label>
      <input id="importFile" type="file" accept="application/json" hidden />
      <button id="btnBookmarklet">Bookmarklet</button>
      <button id="btnReset" class="danger" title="Clear all data">Reset</button>
    </div>

    <p class="hint" style="margin-top: 8px; text-align: center">
      Drag cards between columns. Everything saves to <strong>localStorage</strong>. Use
      <span class="kbd">Export</span> to back up or sync via Git/Gist. Keyboard: <span class="kbd">A</span> add,
      <span class="kbd">/</span> search.
    </p>

    <!-- Add/Edit Dialog -->
    <dialog id="dialog">
      <form method="dialog">
        <div class="dlg-head">
          <h3 id="dlgTitle">Add Link</h3>
          <button class="pill alt" value="cancel" aria-label="Close" formnovalidate>âœ•</button>
        </div>
        <div class="dlg-body">
          <div class="row">
            <label for="fUrl">URL</label>
            <input id="fUrl" type="text" placeholder="https://example.com/tool" required />
          </div>
          <div class="row">
            <label for="fTitle">Title (optional â€” will default to domain)</label>
            <input id="fTitle" type="text" />
          </div>
          <div class="row">
            <label for="fNote">Note (optional)</label>
            <textarea id="fNote" placeholder="Why this is useful / what to use it forâ€¦"></textarea>
          </div>
          <div class="row">
            <label for="fCol">Column</label>
            <select id="fCol"></select>
          </div>
        </div>
        <div class="dlg-foot">
          <button class="pill alt" value="cancel" formnovalidate>Cancel</button>
          <button id="dlgDelete" class="pill danger" value="delete" style="display: none">Delete</button>
          <button id="dlgSave" class="pill" value="default">Save</button>
        </div>
      </form>
    </dialog>

    <!-- Bookmarklet Dialog -->
    <dialog id="dlgBm">
      <div class="dlg-head">
        <h3>Addâ€‘toâ€‘LinkBoard Bookmarklet</h3>
        <form method="dialog"><button class="pill alt">âœ•</button></form>
      </div>
      <div class="dlg-body">
        <div class="row">
          <label>Drag this to your bookmarks bar:</label>
          <p><a id="bmLink" href="#" style="word-break: break-all">Add to LinkBoard</a></p>
          <p class="hint">
            When clicked on any page, it opens LinkBoard (this file) and preâ€‘fills the link using URL parameters.
            LinkBoard will add it to the selected column.
          </p>
        </div>
      </div>
    </dialog>

    <!-- Manage Columns Dialog -->
    <dialog id="dlgCols">
      <form method="dialog">
        <div class="dlg-head">
          <h3>Manage Columns</h3>
          <button class="pill alt" value="cancel" aria-label="Close" formnovalidate>âœ•</button>
        </div>
        <div class="dlg-body">
          <div id="colsList" class="cols-list"></div>
          <div style="display: flex; gap: 8px; justify-content: flex-start; margin-top: 6px">
            <button type="button" class="pill" id="btnAddCol">+ Add Column</button>
          </div>
          <p class="hint colmgr-hint">Deleting a column moves its cards to a destination of your choice.</p>
        </div>
        <div class="dlg-foot">
          <button class="pill alt" value="cancel">Close</button>
          <button id="btnColsSave" class="pill" value="default">Save</button>
        </div>
      </form>
    </dialog>

    <!-- Delete Column Destination Dialog -->
    <dialog id="dlgColDel">
      <form method="dialog">
        <div class="dlg-head">
          <h3>Delete Column</h3>
          <button class="pill alt" value="cancel" aria-label="Close" formnovalidate>âœ•</button>
        </div>
        <div class="dlg-body">
          <p id="delColInfo" style="margin: 0 0 16px 0; color: var(--text);"></p>
          <div class="row">
            <label for="delDest">Move its cards to:</label>
            <select id="delDest"></select>
          </div>
        </div>
        <div class="dlg-foot">
          <button class="pill alt" value="cancel" formnovalidate>Cancel</button>
          <button class="pill danger" value="default">Delete Column</button>
        </div>
      </form>
    </dialog>

    <script
      src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"
      integrity="sha256-ymhDBwPE9ZYOkHNYZ8bpTSm1o943EH2BAOWjAQB+nm4="
      crossorigin="anonymous"
    ></script>
    <script>
      // â€”â€”â€” Theme â€”â€”â€”
      const THEME_KEY = "linkboard.theme";
      function applyTheme(theme) {
        document.documentElement.setAttribute("data-theme", theme);
        const b = document.getElementById("btnTheme");
        if (b) {
          b.textContent = theme === "dark" ? "â˜€ï¸ Light" : "ðŸŒ™ Dark";
        }
      }
      (function initTheme() {
        let saved = localStorage.getItem(THEME_KEY);
        if (!saved) {
          const mql = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)");
          saved = mql && mql.matches ? "dark" : "light";
        }
        applyTheme(saved);
        const btn = document.getElementById("btnTheme");
        if (btn) {
          btn.addEventListener("click", () => {
            const cur = document.documentElement.getAttribute("data-theme") === "dark" ? "light" : "dark";
            localStorage.setItem(THEME_KEY, cur);
            applyTheme(cur);
          });
        }
      })();

      // â€”â€”â€” Data & Storage â€”â€”â€”
      const STORAGE_KEY = "linkboard.v1";

      const INITIAL_COLUMN_COUNT = 3;

      function createBlankColumns(count = INITIAL_COLUMN_COUNT) {
        return Array.from({ length: count }, (_, idx) => ({
          id: uid(),
          title: `Column ${idx + 1}`,
          cards: [],
        }));
      }

      function createInitialState() {
        return { columns: createBlankColumns() };
      }

      /** @typedef {{id:string,url:string,title?:string,note?:string}} Card */
      /** @type {{columns: {id:string,title:string,cards: Card[]}[]}} */
      let state = load();
      if (!state) state = createInitialState();
      migrateState();
      save();

      function load() {
        try {
          return JSON.parse(localStorage.getItem(STORAGE_KEY));
        } catch {
          return null;
        }
      }
      function save() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      }

      // â€”â€”â€” Utils â€”â€”â€”
      function uid() {
        return Math.random().toString(36).slice(2, 9);
      }
      function domainFrom(url) {
        try {
          return new URL(url).hostname.replace(/^www\./, "");
        } catch {
          return url;
        }
      }
      function normalizeUrl(value) {
        if (typeof value !== "string") return "";
        let raw = value.trim();
        if (!raw) return "";
        if (raw.startsWith("//")) {
          raw = "https:" + raw;
        } else if (!/^[a-zA-Z][a-zA-Z0-9+.-]*:/.test(raw)) {
          raw = "https://" + raw;
        }
        try {
          const url = new URL(raw);
          if (url.protocol !== "http:" && url.protocol !== "https:") return "";
          return url.toString();
        } catch {
          return "";
        }
      }
      function favicon(url) {
        const host = domainFrom(url);
        return `https://icons.duckduckgo.com/ip2/${host}.ico`;
      }
      function ensureColumns() {
        if (!Array.isArray(state.columns)) state.columns = [];
        if (state.columns.length === 0) {
          state.columns = createBlankColumns();
        }
      }
      function migrateState() {
        if (!state || !Array.isArray(state.columns)) {
          state = createInitialState();
          return;
        }
        state.columns = state.columns.map((c) => ({
          id: c.id || uid(),
          title: c.title || "Untitled",
          cards: Array.isArray(c.cards) ? c.cards : [],
        }));
        ensureColumns();
      }

      // â€”â€”â€” Rendering â€”â€”â€”
      const boardEl = document.getElementById("board");
      const searchEl = document.getElementById("q");

      function render() {
        ensureColumns();
        boardEl.innerHTML = "";
        const q = searchEl.value.trim().toLowerCase();
        for (const col of state.columns) {
          const colEl = document.createElement("section");
          colEl.className = "col";
          colEl.dataset.colId = col.id;
          colEl.innerHTML = `<header><h2>${escapeHTML(col.title)}</h2></header><ul class="list" id="list-${
            col.id
          }"></ul>`;
          const list = colEl.querySelector(".list");
          const items = (col.cards || []).filter((card) => !q || matches(card, q));
          if (!items.length) {
            const emptyMsg = q ? "No matching links" : "No links yet";
            list.insertAdjacentHTML("beforeend", `<li class="empty">${emptyMsg}</li>`);
          } else {
            for (const card of items) {
              list.appendChild(cardEl(card));
            }
          }
          boardEl.appendChild(colEl);
          makeSortable(list);
        }
      }

      function matches(card, q) {
        return (
          (card.title || "").toLowerCase().includes(q) ||
          (card.url || "").toLowerCase().includes(q) ||
          (card.note || "").toLowerCase().includes(q)
        );
      }

      function cardEl(card) {
        const li = document.createElement("li");
        li.className = "card";
        li.dataset.cardId = card.id;

        const normalizedUrl = normalizeUrl(card.url || "");
        const displayUrl = normalizedUrl || (typeof card.url === "string" ? card.url.trim() : "");
        const titleText = (card.title || "").trim() || domainFrom(displayUrl) || displayUrl || "Untitled";

        const iconDiv = document.createElement("div");
        iconDiv.className = "icon";
        if (normalizedUrl) {
          const img = document.createElement("img");
          img.src = favicon(normalizedUrl);
          img.alt = "";
          iconDiv.appendChild(img);
        }

        const contentDiv = document.createElement("div");
        if (normalizedUrl) {
          const link = document.createElement("a");
          link.className = "title";
          link.textContent = titleText;
          link.href = normalizedUrl;
          link.target = "_blank";
          link.rel = "noopener";
          contentDiv.appendChild(link);
        } else {
          const span = document.createElement("span");
          span.className = "title";
          span.textContent = titleText;
          contentDiv.appendChild(span);
        }

        const meta = document.createElement("div");
        meta.className = "meta";
        const domainText = domainFrom(displayUrl);
        const noteText = (card.note || "").trim();
        if (domainText) meta.append(domainText);
        if (noteText) {
          if (domainText) meta.append(" â€¢ ");
          meta.append(noteText);
        }
        contentDiv.appendChild(meta);

        const buttons = document.createElement("div");
        buttons.className = "buttons";
        const editBtn = document.createElement("button");
        editBtn.className = "btn-icon";
        editBtn.title = "Edit";
        editBtn.setAttribute("aria-label", "Edit");
        editBtn.dataset.act = "edit";
        editBtn.textContent = "âœŽ";
        const deleteBtn = document.createElement("button");
        deleteBtn.className = "btn-icon";
        deleteBtn.title = "Delete";
        deleteBtn.setAttribute("aria-label", "Delete");
        deleteBtn.dataset.act = "del";
        deleteBtn.textContent = "ðŸ—‘";
        buttons.append(editBtn, deleteBtn);

        li.append(iconDiv, contentDiv, buttons);

        li.addEventListener("click", (e) => {
          const act = e.target?.dataset?.act;
          if (act === "edit") openDialog(card, findColIdByCard(card.id));
          if (act === "del") removeCard(card.id);
        });
        return li;
      }

      function findColIdByCard(id) {
        ensureColumns();
        for (const c of state.columns) {
          if (c.cards.some((x) => x.id === id)) return c.id;
        }
        return state.columns[0]?.id || null;
      }

      function makeSortable(listEl) {
        if (typeof Sortable === "undefined") {
          return;
        } // graceful if CDN blocked
        new Sortable(listEl, {
          group: { name: "board", pull: true, put: true },
          animation: 150,
          emptyInsertThreshold: 10,
          draggable: ".card",
          onEnd() {
            persistOrder();
          },
        });
      }

      function persistOrder() {
        if (searchEl.value.trim()) {
          render();
          return;
        }
        const newState = { columns: [] };
        for (const col of state.columns) {
          const listEl = document.getElementById("list-" + col.id);
          if (!listEl) {
            newState.columns.push({ id: col.id, title: col.title, cards: col.cards });
            continue;
          }
          const ids = Array.from(listEl.querySelectorAll(".card")).map((li) => li.dataset.cardId);
          const newCards = ids.map((id) => findCardById(id)).filter(Boolean);
          newState.columns.push({ id: col.id, title: col.title, cards: newCards });
        }
        state = newState;
        save();
        render();
      }

      function findCardById(id) {
        for (const c of state.columns) {
          const f = c.cards.find((x) => x.id === id);
          if (f) return f;
        }
        return null;
      }

      // â€”â€”â€” CRUD â€”â€”â€”
      function addCard(card, colId) {
        const col = state.columns.find((c) => c.id === colId) || state.columns[0];
        col.cards.unshift({ id: uid(), ...card });
        save();
        render();
      }
      function updateCard(id, updates, newColId) {
        for (const c of state.columns) {
          const idx = c.cards.findIndex((x) => x.id === id);
          if (idx > -1) {
            const [card] = c.cards.splice(idx, 1);
            const merged = { ...card, ...updates };
            const target = state.columns.find((cc) => cc.id === newColId) || c;
            target.cards.splice(0, 0, merged);
            save();
            render();
            return;
          }
        }
      }
      function removeCard(id) {
        if (!confirm("Delete this link?")) return;
        for (const c of state.columns) {
          const idx = c.cards.findIndex((x) => x.id === id);
          if (idx > -1) {
            c.cards.splice(idx, 1);
            save();
            render();
            return;
          }
        }
      }

      // â€”â€”â€” Column operations (shared) â€”â€”â€”
      function deleteColumn(colId, destId, { commit = true, columns = state.columns } = {}) {
        if (!Array.isArray(columns) || columns.length <= 1) return false;
        const srcIdx = columns.findIndex((c) => c.id === colId);
        const dest = columns.find((c) => c.id === destId && c.id !== colId) || columns.find((c) => c.id !== colId);
        if (srcIdx === -1 || !dest) return false;
        const src = columns[srcIdx];
        dest.cards.push(...(src.cards || []));
        columns.splice(srcIdx, 1);
        if (commit) {
          save();
          render();
        }
        return true;
      }
      function swapColumns(i, j, columns = state.columns) {
        if (!Array.isArray(columns)) return;
        if (i < 0 || j < 0 || i >= columns.length || j >= columns.length) return;
        const tmp = columns[i];
        columns[i] = columns[j];
        columns[j] = tmp;
      }

      // â€”â€”â€” Dialog â€”â€”â€”
      const dlg = document.getElementById("dialog");
      const dlgTitle = document.getElementById("dlgTitle");
      const fUrl = document.getElementById("fUrl");
      const fTitle = document.getElementById("fTitle");
      const fNote = document.getElementById("fNote");
      const fCol = document.getElementById("fCol");
      const dlgDelete = document.getElementById("dlgDelete");

      function readDialogData() {
        const raw = (fUrl.value || "").trim();
        if (!raw) {
          alert("Please enter a URL.");
          return null;
        }
        if (/^[a-zA-Z][a-zA-Z0-9+.-]*:/.test(raw) && !/^https?:/i.test(raw)) {
          alert("Only HTTP and HTTPS URLs are allowed.");
          return null;
        }
        const normalizedUrl = normalizeUrl(raw);
        if (!normalizedUrl) {
          alert("Please enter a valid URL (http:// or https://).");
          return null;
        }
        return {
          url: normalizedUrl,
          title: fTitle.value.trim(),
          note: fNote.value.trim(),
        };
      }

      function openDialog(card = null, colId = null) {
        ensureColumns();
        fCol.innerHTML = state.columns
          .map((c, i) => `<option value="${c.id}">${i + 1}. ${escapeHTML(c.title)}</option>`)
          .join("");
        if (card) {
          dlgTitle.textContent = "Edit Link";
          fUrl.value = card.url;
          fTitle.value = card.title || "";
          fNote.value = card.note || "";
          fCol.value = colId || findColIdByCard(card.id);
          dlgDelete.style.display = "inline-block";
          dlg.returnValue = "";
          dlg.showModal();
          dlg.addEventListener(
            "close",
            function onClose() {
              dlg.removeEventListener("close", onClose);
              if (dlg.returnValue === "delete") {
                removeCard(card.id);
                return;
              }
              if (dlg.returnValue === "cancel") return;
              const data = readDialogData();
              if (!data) {
                dlg.returnValue = "";
                dlg.showModal();
                dlg.addEventListener("close", onClose, { once: true });
                setTimeout(() => fUrl.focus(), 50);
                return;
              }
              updateCard(card.id, data, fCol.value);
            },
            { once: true }
          );
        } else {
          dlgTitle.textContent = "Add Link";
          fUrl.value = "";
          fTitle.value = "";
          fNote.value = "";
          fCol.value = colId || state.columns[0].id;
          dlgDelete.style.display = "none";
          dlg.returnValue = "";
          dlg.showModal();
          dlg.addEventListener(
            "close",
            function onClose() {
              dlg.removeEventListener("close", onClose);
              if (dlg.returnValue === "cancel") return;
              const data = readDialogData();
              if (!data) {
                dlg.returnValue = "";
                dlg.showModal();
                dlg.addEventListener("close", onClose, { once: true });
                setTimeout(() => fUrl.focus(), 50);
                return;
              }
              if (!data.title) data.title = domainFrom(data.url);
              addCard(data, fCol.value);
            },
            { once: true }
          );
        }
        setTimeout(() => fUrl.focus(), 50);
      }

      // â€”â€”â€” Export/Import/Reset â€”â€”â€”
      document.getElementById("btnExport").addEventListener("click", () => {
        const blob = new Blob([JSON.stringify(state, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = Object.assign(document.createElement("a"), { href: url, download: "linkboard.json" });
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      });
      document.getElementById("importFile").addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const imported = JSON.parse(reader.result);
            
            // Validate structure
            if (!imported || typeof imported !== "object") {
              throw new Error("Invalid data structure");
            }
            if (!Array.isArray(imported.columns)) {
              throw new Error("Missing or invalid 'columns' array");
            }
            
            // Validate each column
            for (const col of imported.columns) {
              if (!col || typeof col !== "object") {
                throw new Error("Invalid column structure");
              }
              if (typeof col.id !== "string" && typeof col.id !== "number") {
                throw new Error("Column missing valid 'id'");
              }
              if (typeof col.title !== "string") {
                throw new Error("Column missing valid 'title'");
              }
              if (!Array.isArray(col.cards)) {
                throw new Error("Column missing 'cards' array");
              }
              
              // Validate each card
              for (const card of col.cards) {
                if (!card || typeof card !== "object") {
                  throw new Error("Invalid card structure");
                }
                if (typeof card.id !== "string" && typeof card.id !== "number") {
                  throw new Error("Card missing valid 'id'");
                }
                if (typeof card.url !== "string") {
                  throw new Error("Card missing valid 'url'");
                }
                // title and note are optional
              }
            }
            
            // All validations passed, accept the import
            state = imported;
            migrateState();
            save();
            render();
            alert("Import successful!");
          } catch (err) {
            alert("Import failed: " + (err.message || "Invalid JSON file"));
          }
        };
        reader.readAsText(file);
      });
      document.getElementById("btnReset").addEventListener("click", () => {
        if (confirm("Clear all LinkBoard data?")) {
          const columns = Array.isArray(state.columns) && state.columns.length
            ? state.columns.map((col, idx) => ({
                id: col.id || uid(),
                title: (col.title || "").trim() || `Column ${idx + 1}`,
                cards: [],
              }))
            : createBlankColumns();
          state = { columns };
          save();
          render();
        }
      });

      // â€”â€”â€” Search & Keyboard â€”â€”â€”
      searchEl.addEventListener("input", render);
      document.addEventListener("keydown", (e) => {
        // Escape key closes any open dialog
        if (e.key === "Escape") {
          if (dlg.open) {
            dlg.close("cancel");
            e.preventDefault();
          } else if (dlgCols.open) {
            dlgCols.close("cancel");
            e.preventDefault();
          } else if (dlgColDel.open) {
            dlgColDel.close("cancel");
            e.preventDefault();
          } else if (document.getElementById("dlgBm").open) {
            document.getElementById("dlgBm").close();
            e.preventDefault();
          }
        }
        if (e.key === "/" && !dlg.open && document.activeElement !== searchEl) {
          e.preventDefault();
          searchEl.focus();
        }
        if ((e.key === "a" || e.key === "A") && !dlg.open) {
          e.preventDefault();
          openDialog();
        }
      });

      // â€”â€”â€” Buttons â€”â€”â€”
      document.getElementById("btnAdd").addEventListener("click", () => openDialog());
      document.getElementById("btnCols").addEventListener("click", () => openColsDialog());

      // â€”â€”â€” Column Manager â€”â€”â€”
      const dlgCols = document.getElementById("dlgCols");
      const colsList = document.getElementById("colsList");
      const btnAddCol = document.getElementById("btnAddCol");
      const dlgColDel = document.getElementById("dlgColDel");
      const delDest = document.getElementById("delDest");

      let stagedColumns = null;
      function getWorkingColumns() {
        return stagedColumns || state.columns;
      }
      function syncColsInputs() {
        if (!stagedColumns) return;
        colsList.querySelectorAll("input[data-col-id]").forEach((inp) => {
          const col = stagedColumns.find((c) => c.id === inp.dataset.colId);
          if (col) {
            col.title = inp.value;
          }
        });
      }

      function openColsDialog() {
        ensureColumns();
        stagedColumns = state.columns.map((col) => ({
          id: col.id,
          title: col.title,
          originalTitle: col.title,
          cards: [...col.cards],
        }));
        renderColsManager();
        dlgCols.returnValue = "";
        dlgCols.showModal();
        dlgCols.addEventListener(
          "close",
          function onClose() {
            dlgCols.removeEventListener("close", onClose);
            if (dlgCols.returnValue === "cancel") {
              stagedColumns = null;
              return;
            }
            syncColsInputs();
            stagedColumns.forEach((col) => {
              const trimmed = (col.title || "").trim();
              col.title = trimmed || col.originalTitle || "Untitled";
              delete col.originalTitle;
            });
            state.columns = stagedColumns.map((col) => ({ id: col.id, title: col.title, cards: [...col.cards] }));
            stagedColumns = null;
            save();
            render();
          },
          { once: true }
        );
      }

      function renderColsManager() {
        syncColsInputs();
        colsList.innerHTML = "";
        const columns = getWorkingColumns();
        columns.forEach((c, idx) => {
          const row = document.createElement("div");
          row.className = "colmgr-row";
          row.innerHTML = `
        <div class="order">
          <button type="button" class="btn-icon" title="Move up" data-up="${idx}">â†‘</button>
          <button type="button" class="btn-icon" title="Move down" data-down="${idx}">â†“</button>
        </div>
        <input type="text" data-col-id="${c.id}" value="${escapeHTML(c.title)}" />
        <div class="colmgr-actions">
          <button type="button" class="btn-icon" title="Delete" data-del="${c.id}">ðŸ—‘</button>
        </div>`;

          // Up/Down reorder
          row.querySelector("[data-up]").addEventListener("click", (e) => {
            const i = parseInt(e.currentTarget.getAttribute("data-up"), 10);
            if (i > 0) {
              swapColumns(i, i - 1, columns);
              renderColsManager();
            }
          });
          row.querySelector("[data-down]").addEventListener("click", (e) => {
            const i = parseInt(e.currentTarget.getAttribute("data-down"), 10);
            if (i < columns.length - 1) {
              swapColumns(i, i + 1, columns);
              renderColsManager();
            }
          });

          // Delete with destination select dialog
          row.querySelector("[data-del]").addEventListener("click", () => {
            if (columns.length <= 1) {
              alert("At least one column is required.");
              return;
            }
            // Show column info with card count
            const cardCount = c.cards.length;
            const cardText = cardCount === 1 ? "1 card" : `${cardCount} cards`;
            const delColInfo = document.getElementById("delColInfo");
            delColInfo.textContent = `Delete "${c.title}" with ${cardText}?`;
            
            // Build dest options excluding this column
            delDest.innerHTML = columns
              .filter((x) => x.id !== c.id)
              .map((x, i) => `<option value="${x.id}">${i + 1}. ${escapeHTML(x.title)}</option>`)
              .join("");
            dlgColDel.returnValue = "";
            dlgColDel.showModal();
            dlgColDel.addEventListener(
              "close",
              function onClose() {
                dlgColDel.removeEventListener("close", onClose);
                if (dlgColDel.returnValue === "cancel") return;
                const destId = delDest.value;
                const ok = deleteColumn(c.id, destId, { commit: false, columns });
                if (!ok) {
                  alert("Could not delete column.");
                  return;
                }
                renderColsManager();
              },
              { once: true }
            );
          });

          colsList.appendChild(row);
        });
      }

      btnAddCol.addEventListener("click", () => {
        const title = prompt("New column name?", "New Column");
        if (!title) return;
        if (!stagedColumns) {
          stagedColumns = state.columns.map((col) => ({
            id: col.id,
            title: col.title,
            originalTitle: col.title,
            cards: [...col.cards],
          }));
        }
        syncColsInputs();
        stagedColumns.push({ id: uid(), title: title.trim(), originalTitle: title.trim(), cards: [] });
        renderColsManager();
      });

      // Bookmarklet support
      const bmDlg = document.getElementById("dlgBm");
      document.getElementById("btnBookmarklet").addEventListener("click", () => {
        const here = location.href.split("#")[0];
        const js = `javascript:((()=>{const u=encodeURIComponent(location.href),t=encodeURIComponent(document.title);window.open('${here}?add='+u+'&title='+t,'_blank');})())`;
        const link = document.getElementById("bmLink");
        link.textContent = "Add to LinkBoard";
        link.href = js;
        bmDlg.showModal();
      });

      // On-load: check for ?add= URL param from bookmarklet
      (function initFromParams() {
        const p = new URLSearchParams(location.search);
        const add = p.get("add");
        if (add) {
          const title = decodeURIComponent(p.get("title") || "");
          openDialog({ id: uid(), url: decodeURIComponent(add), title, note: "" });
          history.replaceState({}, "", location.pathname); // clean URL
        }
      })();

      // â€”â€”â€” Bootstrap â€”â€”â€”
      render();

      // â€”â€”â€” Helpers â€”â€”â€”
      function escapeHTML(str) {
        return (str || "").replace(
          /[&<>"']/g,
          (s) => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[s])
        );
      }

      // â€”â€”â€” Optional Selfâ€‘Tests (run only with #selftest) â€”â€”â€”
      (function selfTests() {
        if (location.hash !== "#selftest") return;
        const log = (...a) => console.log("[LinkBoard selftest]", ...a);
        try {
          const snapshot = localStorage.getItem(STORAGE_KEY);
          log("state loaded?", !!state, "columns:", state.columns?.length);
          if (!state || !Array.isArray(state.columns) || !state.columns.length) throw new Error("No columns at start");

          // Add + remove a temp card in first column
          const firstCol = state.columns[0].id;
          const temp = { id: uid(), url: "https://example.org", title: "TEMP", note: "self-test" };
          addCard({ url: temp.url, title: temp.title, note: temp.note }, firstCol);
          const added = state.columns[0].cards.find((c) => c.title === "TEMP");
          if (!added) throw new Error("Add failed");
          removeCard(added.id);

          // Create a temp column, rename it, add a card, then simulate delete
          const beforeCols = state.columns.length;
          state.columns.push({ id: "tmp-col", title: "Temp Column", cards: [] });
          save();
          render();
          const tmp = state.columns.find((c) => c.id === "tmp-col");
          tmp.title = "Renamed Temp";
          addCard({ url: "https://example.com", title: "T1", note: "" }, tmp.id);
          const dest = state.columns.find((c) => c.id !== "tmp-col");
          dest.cards.push(...tmp.cards);
          state.columns = state.columns.filter((c) => c.id !== "tmp-col");
          if (state.columns.length !== beforeCols) throw new Error("Delete column failed");
          save();
          render();

          log("PASS");

          // Restore original state
          if (snapshot) {
            localStorage.setItem(STORAGE_KEY, snapshot);
            state = JSON.parse(snapshot);
            render();
          }
        } catch (err) {
          console.error("[LinkBoard selftest] FAIL", err);
        }
      })();

      // Extra test suite (run with #test-columns)
      (function columnTests() {
        if (location.hash !== "#test-columns") return;
        const log = (...a) => console.log("[LinkBoard column tests]", ...a);
        const snapshot = localStorage.getItem(STORAGE_KEY);
        try {
          // Start clean
          state = createInitialState();
          save();
          render();
          log("start columns", state.columns.length);
          // Add column
          state.columns.push({ id: "c2", title: "Added", cards: [] });
          save();
          render();
          // Add card to new col
          addCard({ url: "https://example.com/x", title: "X" }, "c2");
          // Rename
          const c2 = state.columns.find((c) => c.id === "c2");
          c2.title = "AddedRenamed";
          // Delete and move cards
          const dest = state.columns[0];
          dest.cards.push(...c2.cards);
          state.columns = state.columns.filter((c) => c.id !== "c2");
          save();
          render();
          log("end columns", state.columns.length);
          // Restore snapshot
          if (snapshot) {
            localStorage.setItem(STORAGE_KEY, snapshot);
            state = JSON.parse(snapshot);
            render();
          }
          log("PASS");
        } catch (e) {
          console.error("[LinkBoard column tests] FAIL", e);
        }
      })();

      // Destination delete test (run with #test-dest-delete)
      (function destDeleteTests() {
        if (location.hash !== "#test-dest-delete") return;
        const log = (...a) => console.log("[LinkBoard dest delete tests]", ...a);
        const snapshot = localStorage.getItem(STORAGE_KEY);
        try {
          state = {
            columns: [
              { id: "A", title: "A", cards: [{ id: "1", url: "https://a.com", title: "a" }] },
              { id: "B", title: "B", cards: [] },
              { id: "C", title: "C", cards: [] },
            ],
          };
          save();
          render();
          const ok = deleteColumn("A", "C");
          if (!ok) throw new Error("deleteColumn returned false");
          if (state.columns.find((c) => c.id === "A")) throw new Error("A not deleted");
          const c = state.columns.find((c) => c.id === "C");
          if (!c || c.cards.length !== 1) throw new Error("Cards not moved to C");
          log("PASS");
          if (snapshot) {
            localStorage.setItem(STORAGE_KEY, snapshot);
            state = JSON.parse(snapshot);
            render();
          }
        } catch (e) {
          console.error("[LinkBoard dest delete tests] FAIL", e);
        }
      })();
    </script>
  </body>
</html>
